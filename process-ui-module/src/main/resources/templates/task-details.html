<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Details - Process Orchestrator</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-details-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .task-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .task-details-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .task-details-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border: none;
            padding: 15px;
        }
        .task-details-table td {
            padding: 15px;
            border: none;
            border-bottom: 1px solid #e9ecef;
        }
        .task-details-table tr:last-child td {
            border-bottom: none;
        }
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .back-button:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .status-running {
            background-color: #d4edda;
            color: #155724;
        }
        .status-completed {
            background-color: #cce5ff;
            color: #004085;
        }
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="task-details-container">
        <a href="/dashboard" class="back-button">‚Üê Back to Dashboard</a>
        
        <div class="task-header">
            <h1>Task Details</h1>
            <p class="mb-0" id="task-instance-id">Loading...</p>
        </div>

        <div class="task-details-table">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 30%;">Parameter</th>
                        <th style="width: 70%;">Value</th>
                    </tr>
                </thead>
                <tbody id="task-details-tbody">
                    <tr>
                        <td colspan="2" class="text-center">Loading task details...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Get task ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');
        
        if (!taskId) {
            document.getElementById('task-instance-id').textContent = 'Error: No task ID provided';
            document.getElementById('task-details-tbody').innerHTML = 
                '<tr><td colspan="2" class="text-center text-danger">Error: No task ID provided</td></tr>';
        } else {
            document.getElementById('task-instance-id').textContent = 'Task ID: ' + taskId;
            loadTaskDetails(taskId);
        }

        async function loadTaskDetails(taskId) {
            try {
                const response = await fetch('/api/task-details/' + taskId);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                const taskDetails = await response.json();
                
                if (Object.keys(taskDetails).length === 0) {
                    document.getElementById('task-details-tbody').innerHTML = 
                        '<tr><td colspan="2" class="text-center text-warning">No task details found for this task ID</td></tr>';
                    return;
                }
                
                displayTaskDetails(taskDetails);
            } catch (error) {
                console.error('Error loading task details:', error);
                document.getElementById('task-details-tbody').innerHTML = 
                    '<tr><td colspan="2" class="text-center text-danger">Error loading task details: ' + error.message + '</td></tr>';
            }
        }

        function displayTaskDetails(taskDetails) {
            const tbody = document.getElementById('task-details-tbody');
            tbody.innerHTML = '';
            
            // Define the order and labels for displaying parameters
            const parameterOrder = [
                { key: 'task_id', label: 'Task ID' },
                { key: 'process_record_id', label: 'Process Record ID' },
                { key: 'task_index', label: 'Task Index' },
                { key: 'task_name', label: 'Task Name' },
                { key: 'command', label: 'Command' },
                { key: 'working_directory', label: 'Working Directory' },
                { key: 'timeout_minutes', label: 'Timeout (Minutes)' },
                { key: 'max_retries', label: 'Max Retries' },
                { key: 'status', label: 'Status' },
                { key: 'started_at', label: 'Started At' },
                { key: 'completed_at', label: 'Completed At' },
                { key: 'exit_code', label: 'Exit Code' },
                { key: 'output', label: 'Output' },
                { key: 'error_message', label: 'Error Message' },
                { key: 'retry_count', label: 'Retry Count' }
            ];
            
            parameterOrder.forEach(param => {
                if (taskDetails.hasOwnProperty(param.key)) {
                    const row = document.createElement('tr');
                    const value = taskDetails[param.key];
                    
                    row.innerHTML = 
                        '<td><strong>' + param.label + '</strong></td>' +
                        '<td>' + formatValue(value, param.key) + '</td>';
                    tbody.appendChild(row);
                }
            });
        }

        function formatValue(value, key) {
            if (value === null || value === undefined) {
                return '<span class="text-muted">-</span>';
            }
            
            // Format boolean values
            if (typeof value === 'boolean') {
                return value ? 
                    '<span class="badge bg-success">Yes</span>' : 
                    '<span class="badge bg-secondary">No</span>';
            }
            
            // Format timestamps
            if (key.includes('started_at') || key.includes('completed_at')) {
                try {
                    const date = new Date(value);
                    return date.toLocaleString();
                } catch (e) {
                    return value;
                }
            }
            
            // Format status
            if (key === 'status') {
                const statusClass = getStatusClass(value);
                return '<span class="badge ' + statusClass + '">' + value + '</span>';
            }
            
            // Format exit code
            if (key === 'exit_code') {
                if (value === 0) {
                    return '<span class="badge bg-success">0 (Success)</span>';
                } else {
                    return '<span class="badge bg-danger">' + value + ' (Error)</span>';
                }
            }
            
            // Format retry count
            if (key === 'retry_count') {
                if (value > 0) {
                    return '<span class="badge bg-warning">' + value + '</span>';
                } else {
                    return '<span class="badge bg-success">0</span>';
                }
            }
            
            // Format timeout minutes
            if (key === 'timeout_minutes') {
                return value + ' minutes';
            }
            
            // Format max retries
            if (key === 'max_retries') {
                return value + ' retries';
            }
            
            // Format task index
            if (key === 'task_index') {
                return 'Task ' + value;
            }
            
            // Format output (long text)
            if (key === 'output' && value && value.length > 100) {
                return '<pre class="mb-0" style="max-height: 200px; overflow-y: auto;"><code>' + value + '</code></pre>';
            }
            
            // Format error message
            if (key === 'error_message' && value) {
                return '<span class="text-danger">' + value + '</span>';
            }
            
            return value;
        }
        
        function getStatusClass(status) {
            switch (status) {
                case 'COMPLETED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-primary';
                case 'FAILED': return 'bg-danger';
                case 'STOPPED': return 'bg-secondary';
                default: return 'bg-warning';
            }
        }
    </script>
</body>
</html>
